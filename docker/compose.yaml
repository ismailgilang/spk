name: ${COMPOSE_PROJECT_NAME:-laravel-app}

# ======= ANCHORS / TEMPLATES =======
x-base-service: &base-service
    env_file: .env
    networks: [internal]
    restart: unless-stopped

x-app-build: &app-build
    context: .
    dockerfile: docker/Dockerfile

x-app-environment: &app-environment
    APP_ENV: production
    APP_DEBUG: false
    DB_CONNECTION: mysql
    DB_HOST: mysql
    CACHE_DRIVER: redis
    CACHE_STORE: redis
    QUEUE_CONNECTION: redis
    REDIS_HOST: redis
    LOG_CHANNEL: stderr

x-base-mysql: &base-mysql
    image: mysql:8.1
    hostname: mysql
    environment:
        MYSQL_DATABASE: ${DB_DATABASE:-laravel}
        MYSQL_USER: ${DB_USERNAME:-laravel}
        MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
        MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
    volumes:
        - mysql-data:/var/lib/mysql
        - ./docker/configs/mysql/:/docker-entrypoint-initdb.d:ro
    healthcheck:
        test:
            [
                "CMD",
                "mysqladmin",
                "ping",
                "-h",
                "localhost",
                "-u",
                "root",
                "-p${DB_ROOT_PASSWORD}",
            ]
        interval: 10s
        timeout: 5s
        retries: 5

x-base-redis: &base-redis
    image: redis:alpine
    hostname: redis
    volumes:
        - redis-data:/data
    healthcheck:
        test: ["CMD", "redis-cli", "ping"]
        interval: 10s
        timeout: 5s
        retries: 3

# Nama image produksi diambil dari variabel CI/CD atau .env
x-app-image: &app-image
    image: ${CI_REGISTRY_IMAGE:-$COMPOSE_PROJECT_NAME}:${CI_COMMIT_SHORT_SHA:-latest}

# ======= SERVICES =======
services:
    # --- Development Services ---
    app:
        <<: *base-service
        build:
            <<: *app-build
            target: development
        user: root
        environment:
            <<: *app-environment
            APP_ENV: local
            APP_DEBUG: true
            OCTANE_HTTPS: false
            LOG_CHANNEL: debug
            PUID: ${PUID:-1000} # Pass host user ID
            PGID: ${PGID:-1000} # Pass host group ID
        volumes: [".:/app"]
        profiles: ["dev"]
        ports: ["${FORWARD_APP_PORT:-8000}:8000"]
        command:
            [
                "php",
                "artisan",
                "octane:frankenphp",
                "--host=0.0.0.0",
                "--port=8000",
                "--workers=auto",
                "--watch",
                "--poll",
            ]
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_started
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "test -f /app/vendor/autoload.php && test -d /app/node_modules",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        develop:
            watch:
                - path: ./.env
                  action: sync+restart
                  target: /app/.env

    worker:
        <<: *base-service
        build:
            <<: *app-build
            target: development
        user: root
        environment:
            <<: *app-environment
            APP_ENV: local
            APP_DEBUG: true
            OCTANE_HTTPS: false
            LOG_CHANNEL: debug
            PUID: ${PUID:-1000} # Pass host user ID
            PGID: ${PGID:-1000} # Pass host group ID
        volumes: [".:/app"]
        profiles: ["dev"]
        command:
            [
                "php",
                "artisan",
                "queue:work",
                "--verbose",
                "--tries=3",
                "--timeout=0",
            ]
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_started
            app:
                condition: service_healthy
        healthcheck:
            disable: true

    vite:
        <<: *base-service
        image: node:22-alpine
        working_dir: /app
        command: ["npm", "run", "dev"]
        ports:
            - "${FORWARD_VITE_PORT:-5174}:5173"
        volumes: [".:/app"]
        environment:
            CHOKIDAR_USEPOLLING: true
            WATCHPACK_POLLING: true
            HOST: 0.0.0.0
        depends_on:
            app:
                condition: service_healthy
        profiles: ["dev"]

    # --- Production Services ---
    app-prod:
        <<: [*base-service, *app-image]
        user: root # Start as root to allow entrypoint to change user IDs
        environment:
            <<: *app-environment
            DB_HOST: mysql-prod
            REDIS_HOST: redis-prod
            PUID: ${PUID:-1000} # Pass host user ID
            PGID: ${PGID:-1000} # Pass host group ID
        command:
            [
                "php",
                "artisan",
                "octane:frankenphp",
                "--host=0.0.0.0",
                "--port=8000",
                "--workers=4",
                "--max-requests=1000",
            ]
        ports: ["${FORWARD_APP_PORT:-8000}:8000"]
        profiles: ["prod"]
        volumes: ["storage-data:/app/storage"]
        depends_on:
            mysql-prod:
                condition: service_healthy
            redis-prod:
                condition: service_started
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/up"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 60s

    worker-prod:
        <<: [*base-service, *app-image]
        user: root # Start as root to allow entrypoint to change user IDs
        environment:
            <<: *app-environment
            DB_HOST: mysql-prod
            REDIS_HOST: redis-prod
            PUID: ${PUID:-1000} # Pass host user ID
            PGID: ${PGID:-1000} # Pass host group ID
        command: ["php", "artisan", "queue:work", "--tries=3", "--timeout=0"]
        profiles: ["prod"]
        volumes: ["storage-data:/app/storage"]
        depends_on:
            mysql-prod:
                condition: service_healthy
            redis-prod:
                condition: service_started
            app-prod:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pgrep -f 'php artisan queue:work' > /dev/null || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # --- Common Services ---
    mysql:
        <<: [*base-service, *base-mysql]
        ports: ["${FORWARD_DB_PORT:-3306}:3306"]
        profiles: ["dev"]

    redis:
        <<: [*base-service, *base-redis]
        ports: ["${FORWARD_REDIS_PORT:-6379}:6379"]
        profiles: ["dev"]

    # --- Common Services (prod version) ---
    mysql-prod:
        <<: [*base-service, *base-mysql]
        hostname: mysql-prod
        profiles: ["prod"]

    redis-prod:
        <<: [*base-service, *base-redis]
        hostname: redis-prod
        profiles: ["prod"]

# Definisi Networks
# network 'proxy-net' bisa komentari ketika development,
# tapi lebih direkomendasikan untuk membuat networknya
# agar dapat terhubung dengan external services
networks:
    internal:
    proxy-net:
        external: true

# Definisi Volumes
volumes:
    mysql-data:
    redis-data:
    storage-data:
